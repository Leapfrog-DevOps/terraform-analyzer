name: Terraform Analyzer

on:
  workflow_dispatch:
    inputs:
      source_run_id:
        description: 'Source workflow run ID (find it in the URL of the completed workflow)'
        required: true
        type: string
      source_repository:
        description: 'Source repository (leave blank for current repo)'
        required: false
        default: ''
        type: string

permissions:
  id-token: write
  contents: write
  actions: read
  pull-requests: write

jobs:
  terraform:
    name: cost
    runs-on: ubuntu-latest

    env:
      TF_VERSION: '1.11.4'
      AWS_REGION: ${{ vars.AWS_REGION }}
      ENVIRONMENT: ${{ vars.ENVIRONMENT }}
      DEPLOY_LAMBDA: ${{ vars.DEPLOY_LAMBDA }}
      TF_IN_AUTOMATION: "true"
      TERM: xterm-256color

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Show input parameters
        run: |
          echo "ðŸ” Workflow Parameters:"
          echo "Source Run ID: ${{ github.event.inputs.source_run_id }}"
          echo "Source Repository: ${{ github.event.inputs.source_repository || github.repository }}"
          echo "Current Repository: ${{ github.repository }}"

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with: 
            name: tfplan
            path: .
            github-token: ${{ secrets.TOKEN_GITHUB }}
            repository: ${{ github.event.inputs.source_repository || github.repository }}
            run-id: ${{ github.event.inputs.source_run_id }}

      - name: Verify artifacts
        run: |
          echo "ðŸ“¦ Downloaded artifacts:"
          ls -la
          if [ -f "tfplan" ]; then
            echo "âœ… tfplan artifact found"
          else
            echo "âŒ tfplan artifact not found"
            exit 1
          fi

      - name: Install Infracost
        if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'plan')
        run: |
          terraform show -json tfplan > plan.json
          curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
          echo "$HOME/.infracost/bin" >> $GITHUB_PATH

      - name: Run Infracost
#        if: github.event.inputs.action == 'push'
        env:
          INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
        run: |
          infracost breakdown --path .
          infracost breakdown --path . --format json --out-file infracost.json

      # - name: Run Infracost on diff
      #   if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'plan')
      #   env:
      #     INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
      #   run: |
      #     infracost breakdown --path . --format json --out-file infracost-develop-pr.json

      - name: Check diff infracost
        if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'plan')
        env:
          INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
        run: |
          git fetch origin infracost
          git checkout origin/infracost -- "infracost-develop-pr.json"
          infracost diff --path . --compare-to infracost-develop-pr.json
      

     # push the changes to github branch.
      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get branch name (push or PR)
        id: extract_branch
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "branch_name=${{ github.event.pull_request.base.ref }}-pr" >> "$GITHUB_OUTPUT"
          else
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
            echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"
          fi


      - name: Create/switch to environment branch
        run: |
          git checkout -B infracost

      - name: Copy Infracost JSON to correct filename
        run: |
          FILENAME="infracost-${{ steps.extract_branch.outputs.branch_name }}.json"
          cp ./infracost.json "./$FILENAME"

      - name: Commit Infracost JSON to infracost branch
        run: |
          FILENAME="infracost-${{ steps.extract_branch.outputs.branch_name }}.json"
          git add "$FILENAME"
          git commit -m "Update $FILENAME [skip ci]" || echo "No changes to commit"

      - name: Push to environment branch
        run: |
          git push origin infracost --force