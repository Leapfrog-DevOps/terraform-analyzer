name: Terraform CI/CD - Test

on:
  pull_request:
    branches: [ develop, tf ]
    types: [ opened, reopened, synchronize ]

  workflow_dispatch: # Optional, for manual triggers
    inputs:
      action:
        description: 'Terraform Action'
        required: true
        default: apply
        type: choice
        options:
          - apply
          - plan
      environment:
        description: 'Environment'
        required: true
        default: dev
        type: string

permissions:
  id-token: write
  contents: write
  pull-requests: write
  actions: read

jobs:
  terraform:
    name: Call Terraform Workflow
    uses: Leapfrog-DevOps/terraform-analyzer/.github/workflows/develop.yml@reusable
    with:
      action: ${{ github.event.inputs.action || 'apply' }}
      environment: ${{ github.event.inputs.environment || 'dev' }}
      aws-region: us-east-2
      deploy-lambda: false
    secrets: inherit

  analyzer:
    name: Call Analyzer Workflow
    needs: terraform
    uses: Leapfrog-DevOps/terraform-analyzer/.github/workflows/analyzer.yml@reusable
    with:
      action: ${{ github.event.inputs.action || 'apply' }}
      environment: ${{ github.event.inputs.environment || 'dev' }}
      source_run_id: ${{ github.run_id }}
      source_repository: ${{ github.repository }}
      aws-region: us-east-2
      deploy-lambda: false
    secrets: inherit